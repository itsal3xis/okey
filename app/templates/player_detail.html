<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>{{ p.name }} — okey</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
    <style>
      :root{--bg:#030617;--card:#071426;--muted:#9fb0c9;--accent:#1fb6ff;--glass:rgba(255,255,255,0.04)}
      *{box-sizing:border-box}
      html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#eaf6ff;background:linear-gradient(180deg,#020417 0%,#03112a 100%)}
      a{color:var(--accent);text-decoration:none}

      .container{max-width:1100px;margin:32px auto;padding:20px}

      .back{color:var(--muted);display:inline-block;margin-bottom:18px}

      /* Hero banner */
      .banner{position:relative;border-radius:12px;overflow:hidden;height:300px;display:flex;align-items:flex-end;background-color:#031126}
      .banner::after{content:"";position:absolute;inset:0;background:linear-gradient(180deg,rgba(2,6,18,0.45),rgba(2,6,18,0.75));pointer-events:none;z-index:1}
      .banner-inner{position:relative;z-index:2;display:flex;gap:20px;width:100%;padding:32px}
      .banner .hero-img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;object-position:center 25%;display:block}

      .headshot-wrap{width:260px;flex:0 0 260px;align-self:flex-end;margin-bottom:-95px}
      .headshot{width:260px;height:260px;overflow:hidden;display:block}
      .inline-logo{width:56px;height:56px;object-fit:contain;margin-right:12px}
      .headshot img{width:100%;height:100%;object-fit:cover;display:block}

      .hero-meta{flex:1;display:flex;flex-direction:column;justify-content:flex-end;padding:8px 8px 18px}
      .hero-meta{color:#f8fbff}
      .player-name{font-size:32px;margin:0 0 6px 0;font-weight:800;text-shadow:0 6px 18px rgba(2,6,18,0.7)}
      .sub{color:var(--muted);margin-bottom:10px}

      .stats-row{display:flex;gap:12px;flex-wrap:wrap}
      .stat-card{background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:12px;min-width:110px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
      .stat-num{font-size:22px;font-weight:800}
      .stat-label{font-size:12px;color:var(--muted);margin-top:6px}

      /* index-style stats grid for last 5 games summary */
      .stats-grid{display:flex;gap:12px;margin-top:12px;flex-wrap:wrap}
      .stat{flex:1;min-width:120px;background:rgba(255,255,255,0.02);padding:12px;border-radius:12px;text-align:center;border:1px solid rgba(255,255,255,0.03)}
      .stat .num{font-size:20px;font-weight:800}
      .stat .label{font-size:12px;color:var(--muted);margin-top:6px}

      /* content below */
      /* two equal columns; use minmax(0,1fr) to avoid min-width overflow issues */
      .content{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:20px;margin-top:18px;padding:0 32px;box-sizing:border-box}
      .panel{background:linear-gradient(180deg,rgba(255,255,255,0.015),transparent);border-radius:12px;padding:18px;border:1px solid rgba(255,255,255,0.03)}

      .awards li{margin-bottom:6px}
      /* awards image row */
      .awards-row{display:flex;gap:12px;overflow-x:auto;overflow-y:hidden;padding:8px 4px;white-space:nowrap;-webkit-overflow-scrolling:touch;align-items:center;width:100%;scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.06) transparent}
      .award-item{position:relative;display:inline-block;flex:0 0 auto;width:160px;text-align:center}
      .award-img{width:136px;height:136px;object-fit:contain;border-radius:10px;background:var(--card);padding:10px;display:block;margin:0 auto;border:1px solid rgba(255,255,255,0.03);filter:none}
      .award-caption{font-size:12px;color:var(--muted);margin-top:6px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width:100%}
      .award-badge{position:absolute;right:6px;bottom:6px;background:var(--accent);color:#02131c;padding:4px 8px;border-radius:12px;font-weight:800;font-size:12px}
      .awards-row::-webkit-scrollbar{height:8px}
      .awards-row::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:6px}
      .awards-row::-webkit-scrollbar-track{background:transparent}

      /* two equal columns aligned with banner-inner padding */
      .content{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:20px;margin-top:18px;padding:0 32px;box-sizing:border-box;align-items:start}

      .content > div, .content > aside{width:100%}
      .panel{width:100%;box-sizing:border-box}

      /* small screens */
      @media (max-width:920px){
        .banner{height:220px}
        .container{padding:12px}
        .headshot-wrap{width:160px;flex:0 0 160px;margin-bottom:-60px}
        .headshot{height:160px}
        .player-name{font-size:24px}
        .content{grid-template-columns:1fr}
      }
      @media (max-width:480px){
        .banner .hero-img{object-position:center 18%}
      }
    </style>
    <script>
      function animateCounters(){
        document.querySelectorAll('.stat-num[data-target]').forEach(el=>{
          const target = Number(el.dataset.target)||0; const dur=700; let start=null;
          function step(ts){ if(!start) start=ts; const prog=Math.min((ts-start)/dur,1); el.textContent = Math.floor(prog*target).toLocaleString(); if(prog<1) requestAnimationFrame(step); else el.textContent = target.toLocaleString(); }
          requestAnimationFrame(step);
        });
      }
      document.addEventListener('DOMContentLoaded',()=>{animateCounters()});
    </script>
  </head>
  <body>
    <div class="container">
      <a class="back" href="/players">← back to players</a>

      {# banner uses heroImage if available, falls back to team logo or dark gradient #}
      <div class="banner">
        <img class="hero-img" src="{{ p.heroImage or p.teamLogo or p.headshot or '/static/hero.jpg' }}" alt="{{ p.name }} hero">
        <div class="banner-inner">
          <div class="headshot-wrap">
            <div class="headshot">
              {% if p.headshot %}
                <img src="{{ p.headshot }}" alt="{{ p.name }}">
              {% else %}
                <div style="padding:12px;color:#bfe9ff;font-weight:800;font-size:18px">{{ p.name.split(' ')[0] }}</div>
              {% endif %}
            </div>
          </div>

          <div class="hero-meta">
            <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
              <div style="display:flex;align-items:center;gap:12px">
                {% if p.teamLogo %}
                  <img class="inline-logo" src="{{ p.teamLogo }}" alt="team">
                {% endif %}
                <div>
                  <h1 class="player-name">{{ p.name }}</h1>
                  <div class="sub">{{ p.team }} • {{ p.position }} • Season {{ p.season }}</div>
                </div>
              </div>
            </div>

            <div class="stats-row" style="margin-top:10px">
              <div class="stat-card">
                <div class="stat-num" data-target="{{ p.gamesPlayed or 0 }}">0</div>
                <div class="stat-label">GP</div>
              </div>
              <div class="stat-card">
                <div class="stat-num" data-target="{{ p.goals or 0 }}">0</div>
                <div class="stat-label">G</div>
              </div>
              <div class="stat-card">
                <div class="stat-num" data-target="{{ p.assists or 0 }}">0</div>
                <div class="stat-label">A</div>
              </div>
              <div class="stat-card">
                <div class="stat-num" data-target="{{ p.points or 0 }}">0</div>
                <div class="stat-label">PTS</div>
              </div>
              <div class="stat-card">
                <div class="stat-num" data-target="{{ p.plusMinus or 0 }}">0</div>
                <div class="stat-label">+/-</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="content">
        <div>
          <div class="panel">
            <h4 style="margin:0 0 8px 0">Career</h4>
            <div style="display:flex;gap:12px;align-items:center;justify-content:flex-end;flex-wrap:wrap;margin-bottom:12px">
              <div style="display:flex;gap:12px;min-width:260px;justify-content:flex-end;align-items:center">
                <div style="text-align:center"><div style="font-weight:800">{{ p.careerGamesPlayed or '—' }}</div><div style="color:var(--muted);font-size:12px">GP</div></div>
                <div style="text-align:center"><div style="font-weight:800">{{ p.careerGoals or '—' }}</div><div style="color:var(--muted);font-size:12px">G</div></div>
                <div style="text-align:center"><div style="font-weight:800">{{ p.careerAssists or '—' }}</div><div style="color:var(--muted);font-size:12px">A</div></div>
                <div style="text-align:center"><div style="font-weight:800">{{ p.careerPoints or (p.careerGoals + p.careerAssists) if (p.careerGoals is defined and p.careerAssists is defined) else '—' }}</div><div style="color:var(--muted);font-size:12px">PTS</div></div>
                {% if p.careerGamesPlayed and p.careerGamesPlayed > 0 and p.careerPoints is defined %}
                  {% set ppg = (p.careerPoints / p.careerGamesPlayed) | round(2) %}
                {% else %}
                  {% set ppg = '—' %}
                {% endif %}
                <div style="text-align:center"><div style="font-weight:800">{{ ppg }}</div><div style="color:var(--muted);font-size:12px">PTS/GP</div></div>
              </div>
            </div>
            <div style="border-top:1px solid rgba(255,255,255,0.03);padding-top:12px;margin-top:8px;color:var(--muted);font-size:13px">
              <div><strong>Birth</strong>: {{ p.birthDate or '—' }}</div>
              <div><strong>Number</strong>: {{ p.sweaterNumber or '—' }}</div>
              <div><strong>Shooting %</strong>: {{ p.shootingPctg|default('—') }}</div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px">
            <h4 style="margin-top:0">Awards</h4>
            {% if p.awards and p.awards|length>0 %}
              <div class="awards-row">
                {# iterate awards, show image (or fallback) and a small xN badge when >1 #}
                {% for a in p.awards %}
                  {# determine count: prefer explicit fields, otherwise derive from seasons #}
                  {% if a.count is defined %}
                    {% set cnt = a.count %}
                  {% elif a.times is defined %}
                    {% set cnt = a.times %}
                  {% elif a.seasons is defined %}
                    {% if a.seasons is string %}
                      {% set cnt = (a.seasons|replace(' ', '')|split(',')|length) if a.seasons|length>0 else 0 %}
                    {% else %}
                      {% set cnt = a.seasons|length %}
                    {% endif %}
                  {% else %}
                    {% set cnt = 0 %}
                  {% endif %}

                  {% if cnt and cnt > 0 %}
                    {# build a safer filename from the trophy name and prefer a.image when provided #}
                    {% set raw = a.trophy|lower %}
                    {% set raw = raw|replace("'", '')|replace('’','')|replace('“','')|replace('”','')|replace('"','')|replace(' ', '_')|replace('.', '')|replace(':','')|replace('/','_')|replace('(','')|replace(')','')|replace('–','_')|replace('—','_')|replace('-', '_') %}
                    {% if a.image is defined %}
                      {% set img_src = a.image %}
                      {% set fallback_src = url_for('static', filename=(raw ~ '.png')) %}
                    {% else %}
                      {% set img_src = url_for('static', filename=('awards/' ~ raw ~ '.png')) %}
                      {% set fallback_src = url_for('static', filename=(raw ~ '.png')) %}
                    {% endif %}
                    <div class="award-item">
                      <img class="award-img" src="{{ img_src }}" onerror="this.onerror=null;this.src='{{ fallback_src }}'" alt="{{ a.trophy }}">
                      {% if cnt > 1 %}<div class="award-badge">x{{ cnt }}</div>{% endif %}
                      <div class="award-caption">{{ a.trophy }}</div>
                    </div>
                  {% endif %}
                {% endfor %}
              </div>
              {# nothing else; if no award had cnt>0 the row will be empty, fall back to message #}
              {% set visible_awards = p.awards|selectattr('seasons')|list %}
              {% if visible_awards|length == 0 %}
                <p style="color:var(--muted)">No awards listed.</p>
              {% endif %}
            {% else %}
              <p style="color:var(--muted)">No awards listed.</p>
            {% endif %}
          </div>
        </div>

        <aside>
          <div class="panel">
            <h3 style="margin-top:0">Last 5 Games</h3>
            {% if p.last5Games and p.last5Games|length>0 %}
              {% set games = p.last5Games %}
              {% set gp = games|length %}
              {% set ns = namespace(goals=0, assists=0, points=0, shots=0, pim=0) %}
              {% for g in games %}
                {% set ns.goals = ns.goals + (g.goals|default(0)) %}
                {% set ns.assists = ns.assists + (g.assists|default(0)) %}
                {% set ns.points = ns.points + (g.points|default(0)) %}
                {% set ns.shots = ns.shots + (g.shots|default(0)) %}
                {% set ns.pim = ns.pim + (g.pim|default(0)) %}
              {% endfor %}

              <div class="stats-grid">
                <div class="stat"><div class="num">{{ gp }}</div><div class="label">GP</div></div>
                <div class="stat"><div class="num">{{ ns.goals }}</div><div class="label">G</div></div>
                <div class="stat"><div class="num">{{ ns.assists }}</div><div class="label">A</div></div>
                <div class="stat"><div class="num">{{ ns.points }}</div><div class="label">PTS</div></div>
                <div class="stat"><div class="num">{{ ns.shots }}</div><div class="label">SOG</div></div>
                <div class="stat"><div class="num">{{ ns.pim }}</div><div class="label">PIM</div></div>
              </div>

              <div style="margin-top:12px;display:flex;flex-direction:column;gap:8px">
                {% for g in games %}
                  <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02)">
                    <div style="font-weight:700">{{ g.gameDate or '' }} — {{ g.opponentAbbrev or g.opponent or '' }}</div>
                    <div style="display:flex;gap:10px;min-width:220px;justify-content:flex-end">
                      <div style="text-align:center"><div style="font-weight:800">{{ g.goals or 0 }}</div><div style="color:var(--muted);font-size:12px">G</div></div>
                      <div style="text-align:center"><div style="font-weight:800">{{ g.assists or 0 }}</div><div style="color:var(--muted);font-size:12px">A</div></div>
                      <div style="text-align:center"><div style="font-weight:800">{{ g.points or 0 }}</div><div style="color:var(--muted);font-size:12px">PTS</div></div>
                    </div>
                  </div>
                {% endfor %}
              </div>

            {% else %}
              <p style="color:var(--muted)">No recent games available.</p>
            {% endif %}
          </div>
        </aside>
      </div>
    </div>
  </body>
</html>
